<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Novo Processo - Sistema Jurídico RPPS</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Fonte -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Flatpickr para DatePicker -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>

    <!-- CSS Personalizado -->
    <link rel="stylesheet" href="css/style.css">

    <style>
        body { font-family: 'Inter', sans-serif; }

        /* Animações */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideDown {
            from { opacity: 0; max-height: 0; }
            to { opacity: 1; max-height: 500px; }
        }

        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }

        .animate-slide-down {
            animation: slideDown 0.4s ease-out forwards;
            overflow: hidden;
        }

        /* Input focus */
        .input-focus:focus {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
        }

        /* Cliente card */
        .cliente-card {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border: 2px solid #86efac;
        }

        /* Stepper */
        .step-active {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        }

        .step-complete {
            background: #10b981;
            color: white;
        }

        .step-pending {
            background: #e2e8f0;
            color: #94a3b8;
        }

        /* Loader no botão */
        .btn-loading {
            position: relative;
            color: transparent !important;
        }

        .btn-loading::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            top: 50%;
            left: 50%;
            margin-left: -10px;
            margin-top: -10px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-20 md:pb-0">

    <!-- Navbar Mobile (Topo) -->
    <nav class="bg-slate-800 text-white p-4 shadow-lg sticky top-0 z-40 md:hidden flex justify-between items-center">
        <div class="flex items-center space-x-2">
            <div class="w-8 h-8 bg-white/10 rounded-lg flex items-center justify-center">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"></path></svg>
            </div>
            <span class="font-bold text-lg tracking-tight">RPPS Jurídico</span>
        </div>
    </nav>

    <div class="flex h-screen overflow-hidden">

        <!-- Sidebar (Desktop) -->
        <aside class="hidden md:flex flex-col w-64 bg-slate-800 text-white h-full shrink-0">
            <div class="p-6 border-b border-slate-700">
                <h1 class="text-2xl font-bold flex items-center gap-2">
                    <svg class="w-8 h-8 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"></path></svg>
                    RPPS
                </h1>
                <p class="text-xs text-slate-400 mt-1 pl-10">Jurídico v1.0</p>
            </div>

            <!-- User Info Desktop -->
            <div class="p-6 border-b border-slate-700 bg-slate-900/50">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-blue-500 flex items-center justify-center font-bold text-lg">
                        <span id="user-initials">U</span>
                    </div>
                    <div>
                        <p class="text-sm font-semibold truncate w-32" id="user-name-display">Carregando...</p>
                        <p class="text-xs text-blue-300 uppercase tracking-wider" id="user-profile-display">...</p>
                    </div>
                </div>
            </div>

            <!-- Menu Desktop -->
            <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
                <a href="dashboard.html" class="flex items-center gap-3 px-4 py-3 text-slate-300 hover:bg-slate-700 hover:text-white rounded-lg transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                    Dashboard
                </a>
                <a href="processos.html" class="flex items-center gap-3 px-4 py-3 text-slate-300 hover:bg-slate-700 hover:text-white rounded-lg transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    Processos
                </a>
                <a href="clientes.html" class="flex items-center gap-3 px-4 py-3 text-slate-300 hover:bg-slate-700 hover:text-white rounded-lg transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5-2.83M9 20H4v-2a3 3 0 015-2.83M9 20h6M9 20v-2a3 3 0 016 0v2M12 7a3 3 0 110 6 3 3 0 010-6z"></path></svg>
                    Clientes
                </a>
                <a href="novo-processo.html" class="flex items-center gap-3 px-4 py-3 bg-blue-600 rounded-lg text-white shadow-lg shadow-blue-500/30">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    Novo Processo
                </a>
            </nav>

            <div class="p-4 border-t border-slate-700">
                <button id="desktop-logout-btn" class="flex items-center gap-3 w-full px-4 py-2 text-slate-400 hover:text-red-400 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                    Sair do Sistema
                </button>
            </div>
        </aside>

        <!-- Conteúdo Principal -->
        <main class="flex-1 h-full overflow-y-auto bg-slate-50 p-4 md:p-8">

            <!-- Header da Página -->
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <div>
                    <h2 class="text-2xl font-bold text-slate-800">Novo Processo</h2>
                    <p class="text-slate-500">Cadastre um novo processo no sistema</p>
                </div>
                <a href="processos.html" class="text-slate-500 hover:text-slate-700 flex items-center gap-2 text-sm">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                    Voltar para lista
                </a>
            </div>

            <!-- Stepper -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 mb-6">
                <div class="flex items-center justify-center gap-4">
                    <div class="flex items-center gap-2">
                        <div id="step1-indicator" class="w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold step-active">1</div>
                        <span class="text-sm font-medium text-slate-700 hidden sm:block">Cliente</span>
                    </div>
                    <div class="w-16 h-1 bg-slate-200 rounded-full">
                        <div id="progress-bar" class="h-full bg-blue-500 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                    <div class="flex items-center gap-2">
                        <div id="step2-indicator" class="w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold step-pending">2</div>
                        <span class="text-sm font-medium text-slate-400 hidden sm:block">Processo</span>
                    </div>
                </div>
            </div>

            <!-- Step 1: Cliente -->
            <div id="step1-content" class="animate-fade-in">
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 mb-6">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-slate-800">Identificar Cliente</h3>
                            <p class="text-sm text-slate-500">Busque pelo CPF ou cadastre um novo cliente</p>
                        </div>
                    </div>

                    <!-- Seleção Rápida de Cliente Cadastrado -->
                    <div class="mb-6 p-4 bg-slate-50 border border-slate-200 rounded-xl">
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Selecionar Cliente Cadastrado (rápido)</label>
                        <div class="flex flex-col sm:flex-row gap-3">
                            <div class="relative flex-1">
                                <input
                                    type="text"
                                    id="cliente-busca-rapida"
                                    placeholder="Digite nome, CPF ou email do cliente"
                                    class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl text-slate-800 placeholder-slate-400 focus:outline-none focus:border-blue-500 input-focus transition-all"
                                >
<div id="clientes-sugestoes" class="hidden absolute z-20 mt-1 w-full bg-white border border-slate-200 rounded-lg shadow-xl max-h-60 overflow-y-auto"></div>
                            </div>
                            <button
                                id="btn-usar-cliente-rapido"
                                type="button"
                                class="px-5 py-3 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold rounded-xl shadow-lg shadow-emerald-500/30 transition-all"
                            >
                                Usar Cliente
                            </button>
                        </div>
                        <p class="text-xs text-slate-500 mt-2">Dica: se não encontrar, use a busca por CPF abaixo ou cadastre um cliente novo.</p>
                    </div>

                    <!-- Busca por CPF -->
                    <div class="mb-6">
                        <label class="block text-sm font-semibold text-slate-700 mb-2">CPF do Cliente</label>
                        <div class="flex gap-3">
                            <div class="relative flex-1">
                                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                    <svg class="h-5 w-5 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                    </svg>
                                </div>
                                <input
                                    type="text"
                                    id="cpf-busca"
                                    placeholder="000.000.000-00"
                                    maxlength="14"
                                    class="w-full pl-12 pr-4 py-3 border-2 border-slate-200 rounded-xl text-slate-800 font-medium placeholder-slate-400 focus:outline-none focus:border-blue-500 input-focus transition-all"
                                >
                            </div>
                            <button
                                id="btn-buscar-cpf"
                                type="button"
                                class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl shadow-lg shadow-blue-500/30 transition-all flex items-center gap-2"
                            >
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                                <span>Buscar</span>
                            </button>
                        </div>
                        <p class="text-xs text-slate-400 mt-2">Digite o CPF e clique em buscar para verificar se o cliente já está cadastrado.</p>
                    </div>

                    <!-- Resultado da Busca: Cliente Encontrado -->
                    <div id="cliente-encontrado" class="hidden animate-slide-down">
                        <div class="cliente-card rounded-xl p-5 mb-4">
                            <div class="flex items-start justify-between">
                                <div class="flex items-center gap-4">
                                    <div class="w-14 h-14 bg-green-500 rounded-full flex items-center justify-center text-white text-xl font-bold" id="cliente-iniciais">-</div>
                                    <div>
                                        <p class="text-xs text-green-600 font-semibold uppercase tracking-wider mb-1">✓ Cliente Encontrado</p>
                                        <h3 class="text-lg font-bold text-slate-800" id="cliente-nome">-</h3>
                                        <p class="text-sm text-slate-600" id="cliente-email">-</p>
                                        <p class="text-sm text-slate-500" id="cliente-cpf-display">-</p>
                                    </div>
                                </div>
                                <button type="button" onclick="limparCliente()" class="text-slate-400 hover:text-red-500 transition-colors p-2" title="Remover cliente">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                </button>
                            </div>
                        </div>
                        <input type="hidden" id="cliente-id-selecionado" value="">

                        <button type="button" onclick="avancarParaProcesso()" class="w-full py-4 bg-green-600 hover:bg-green-700 text-white font-bold rounded-xl shadow-lg shadow-green-500/30 transition-all flex items-center justify-center gap-2">
                            Continuar com este Cliente
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                        </button>
                    </div>

                    <!-- Resultado da Busca: Cliente Não Encontrado -->
                    <div id="cliente-nao-encontrado" class="hidden animate-slide-down">
                        <div class="bg-amber-50 border-2 border-amber-200 rounded-xl p-5 mb-6">
                            <div class="flex items-start gap-3">
                                <div class="w-10 h-10 bg-amber-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                    <svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-amber-800">Cliente não encontrado</h4>
                                    <p class="text-sm text-amber-700 mt-1">Nenhum cliente com este CPF está cadastrado. Preencha os dados abaixo para cadastrar.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Formulário Novo Cliente -->
                        <div class="space-y-4">
                            <h4 class="font-semibold text-slate-700 flex items-center gap-2">
                                <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path></svg>
                                Cadastrar Novo Cliente
                            </h4>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-slate-600 mb-1">Nome Completo *</label>
                                    <input
                                        type="text"
                                        id="novo-cliente-nome"
                                        placeholder="Digite o nome completo"
                                        class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl text-slate-800 placeholder-slate-400 focus:outline-none focus:border-blue-500 input-focus transition-all"
                                    >
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-slate-600 mb-1">CPF *</label>
                                    <input
                                        type="text"
                                        id="novo-cliente-cpf"
                                        readonly
                                        class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl text-slate-800 bg-slate-50"
                                    >
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-slate-600 mb-1">Telefone</label>
                                    <input
                                        type="text"
                                        id="novo-cliente-telefone"
                                        placeholder="(00) 00000-0000"
                                        maxlength="15"
                                        class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl text-slate-800 placeholder-slate-400 focus:outline-none focus:border-blue-500 input-focus transition-all"
                                    >
                                </div>

                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-slate-600 mb-1">Email *</label>
                                    <input
                                        type="email"
                                        id="novo-cliente-email"
                                        placeholder="cliente@email.com"
                                        class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl text-slate-800 placeholder-slate-400 focus:outline-none focus:border-blue-500 input-focus transition-all"
                                    >
                                    <p class="text-xs text-slate-400 mt-1">O cliente usará este email para receber o código de acesso.</p>
                                </div>
                            </div>

                            <button type="button" onclick="cadastrarEAvancar()" id="btn-cadastrar-cliente" class="w-full py-4 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-lg shadow-blue-500/30 transition-all flex items-center justify-center gap-2 mt-4">
                                Cadastrar e Continuar
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                            </button>
                        </div>
                    </div>

                    <!-- Opção: Pular cadastro de cliente -->
                    <div id="opcao-pular" class="mt-6 pt-6 border-t border-slate-100 text-center">
                        <button type="button" onclick="pularCadastroCliente()" class="text-slate-500 hover:text-slate-700 text-sm font-medium transition-colors">
                            Continuar sem vincular cliente →
                        </button>
                    </div>
                </div>
            </div>

            <!-- Step 2: Dados do Processo -->
            <div id="step2-content" class="hidden">
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 mb-6 animate-fade-in">
                    <!-- Cliente Selecionado (resumo) -->
                    <div id="resumo-cliente" class="hidden mb-6 pb-6 border-b border-slate-100">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                                    <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                </div>
                                <div>
                                    <p class="text-xs text-green-600 font-medium">Cliente vinculado</p>
                                    <p class="font-semibold text-slate-800" id="resumo-cliente-nome">-</p>
                                </div>
                            </div>
                            <button type="button" onclick="voltarParaCliente()" class="text-blue-600 hover:text-blue-800 text-sm font-medium">Alterar</button>
                        </div>
                    </div>

                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-12 h-12 bg-indigo-100 rounded-xl flex items-center justify-center">
                            <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-slate-800">Dados do Processo</h3>
                            <p class="text-sm text-slate-500">Preencha as informações do processo</p>
                        </div>
                    </div>

                    <form id="form-processo" class="space-y-5">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <!-- Número do Processo -->
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Número do Processo *</label>
                                <input
                                    type="text"
                                    id="numero_processo"
                                    required
                                    placeholder="0000000-00.0000.0.00.0000"
                                    class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl text-slate-800 placeholder-slate-400 focus:outline-none focus:border-blue-500 input-focus transition-all"
                                >
                            </div>

                            <!-- Tipo do Processo -->
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Tipo / Natureza *</label>
                                <select
                                    id="tipo"
                                    required
                                    class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl text-slate-800 focus:outline-none focus:border-blue-500 input-focus transition-all bg-white"
                                >
                                    <option value="">Selecione o tipo</option>
                                    <option value="APOSENTADORIA">Aposentadoria</option>
                                    <option value="PENSÃO">Pensão</option>
                                    <option value="REVISÃO DE BENEFÍCIO">Revisão de Benefício</option>
                                    <option value="COMPENSAÇÃO PREVIDENCIÁRIA">Compensação Previdenciária</option>
                                    <option value="MANDADO DE SEGURANÇA">Mandado de Segurança</option>
                                    <option value="AÇÃO ORDINÁRIA">Ação Ordinária</option>
                                    <option value="RECURSO">Recurso</option>
                                    <option value="OUTROS">Outros</option>
                                </select>
                            </div>

                            <!-- Campo Outros (Condicional) -->
                            <div id="div-tipo-outro" class="md:col-span-2 hidden">
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Especifique o Tipo *</label>
                                <input
                                    type="text"
                                    id="tipo_outro"
                                    placeholder="Digite o tipo do processo"
                                    class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl text-slate-800 placeholder-slate-400 focus:outline-none focus:border-blue-500 input-focus transition-all"
                                >
                            </div>

                            <!-- Parte / Interessado -->
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Parte / Interessado *</label>
                                <input
                                    type="text"
                                    id="parte_nome"
                                    required
                                    placeholder="Nome da parte interessada"
                                    class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl text-slate-800 placeholder-slate-400 focus:outline-none focus:border-blue-500 input-focus transition-all"
                                >
                            </div>

                            <!-- Data de Entrada -->
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Data de Entrada</label>
                                <input
                                    type="text"
                                    id="data_entrada"
                                    placeholder="Selecione a data"
                                    class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl text-slate-800 placeholder-slate-400 focus:outline-none focus:border-blue-500 input-focus transition-all"
                                >
                            </div>

                            <!-- Email do Interessado -->
                            <div class="md:col-span-2">
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Email para Notificações</label>
                                <input
                                    type="email"
                                    id="email_interessado"
                                    placeholder="email@exemplo.com"
                                    class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl text-slate-800 placeholder-slate-400 focus:outline-none focus:border-blue-500 input-focus transition-all"
                                >
                                <p class="text-xs text-slate-400 mt-1">O cliente receberá notificações de movimentações neste email.</p>
                            </div>

                            <!-- Descrição -->
                            <div class="md:col-span-2">
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Descrição / Observações</label>
                                <textarea
                                    id="descricao"
                                    rows="4"
                                    placeholder="Informações adicionais sobre o processo..."
                                    class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl text-slate-800 placeholder-slate-400 focus:outline-none focus:border-blue-500 input-focus transition-all resize-none"
                                ></textarea>
                            </div>
                        </div>

                        <!-- Botões -->
                        <div class="flex flex-col sm:flex-row gap-3 pt-4">
                            <button type="button" onclick="voltarParaCliente()" class="flex-1 py-4 border-2 border-slate-200 text-slate-700 font-semibold rounded-xl hover:bg-slate-50 transition-all flex items-center justify-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                                Voltar
                            </button>
                            <button type="submit" id="btn-salvar" class="flex-1 py-4 bg-green-600 hover:bg-green-700 text-white font-bold rounded-xl shadow-lg shadow-green-500/30 transition-all flex items-center justify-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                Cadastrar Processo
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="h-20 md:h-0"></div> <!-- Espaçador Mobile -->

        </main>
    </div>

    <!-- Bottom Navigation Bar (Mobile Only) -->
    <div class="md:hidden fixed bottom-0 left-0 w-full bg-white border-t border-slate-200 flex justify-around py-3 pb-safe z-50">
        <a href="dashboard.html" class="flex flex-col items-center text-slate-400 hover:text-slate-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
            <span class="text-[10px] font-medium mt-1">Início</span>
        </a>
        <a href="processos.html" class="flex flex-col items-center text-slate-400 hover:text-slate-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
            <span class="text-[10px] font-medium mt-1">Processos</span>
        </a>
        <a href="novo-processo.html" class="flex flex-col items-center text-blue-600">
            <div class="relative">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            </div>
            <span class="text-[10px] font-medium mt-1">Novo</span>
        </a>
        <a href="clientes.html" class="flex flex-col items-center text-slate-400 hover:text-slate-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5-2.83M9 20H4v-2a3 3 0 015-2.83M9 20h6M9 20v-2a3 3 0 016 0v2M12 7a3 3 0 110 6 3 3 0 010-6z"></path></svg>
            <span class="text-[10px] font-medium mt-1">Clientes</span>
        </a>
    </div>

    <!-- Scripts de Infraestrutura -->
    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>

    <script>
        // =====================================================================
        // VARIÁVEIS GLOBAIS
        // =====================================================================

        let clienteSelecionado = null;
        let clienteVinculado = false;
        let listaClientesCache = [];
        let clientesById = {};
        let clienteCandidatoRapido = null;
        let _ultimoToastClienteId = null;
        let _ultimoToastAt = 0;

        // =====================================================================
        // CACHE + SINCRONIZAÇÃO (Clientes <-> Novo Processo)
        // =====================================================================

        // Mesma chave que o API usa: action + '_' + JSON.stringify(params)
        // Para listarClientes com params {}, fica exatamente "listarClientes_{}".
        const CLIENTES_CACHE_KEY = `listarClientes_${JSON.stringify({})}`;
        const CLIENTES_CACHE_TTL_MINUTES = 60;

        // Sync entre abas (Clientes <-> Novo Processo)
        const CLIENTES_SYNC_CHANNEL = 'rpps_juridico_sync';
        const CLIENTES_SYNC_KEY = 'rpps_clientes_last_update';
        let bcClientes = null;

        function sanitizarClienteParaLista(c) {
            if (!c) return null;
            return {
                id: c.id,
                nome_completo: c.nome_completo || '',
                cpf: c.cpf || '',
                email: c.email || '',
                telefone: c.telefone || '',
                status: c.status || ''
            };
        }

        function rebuildClientesIndex() {
            clientesById = {};
            (listaClientesCache || []).forEach(function(c) {
                if (c && c.id) clientesById[String(c.id)] = c;
            });
        }

        function salvarClientesNoCache() {
            if (!Array.isArray(listaClientesCache)) return;
            Utils.Cache.set(CLIENTES_CACHE_KEY, listaClientesCache, CLIENTES_CACHE_TTL_MINUTES);
        }

        function sincronizarClientesDoCache() {
            const cached = Utils.Cache.get(CLIENTES_CACHE_KEY);
            if (Array.isArray(cached) && cached.length) {
                listaClientesCache = cached;
                rebuildClientesIndex();
                popularDatalistClientes();
                renderSugestoesClientes();
            }
        }

        function broadcastClientesUpdated() {
            try { localStorage.setItem(CLIENTES_SYNC_KEY, String(Date.now())); } catch (e) {}
            try {
                if (bcClientes) bcClientes.postMessage({ type: 'clientes_updated', ts: Date.now() });
            } catch (e) {}
        }

        function initClientesSync() {
            // BroadcastChannel (se disponível)
            try {
                if ('BroadcastChannel' in window) {
                    bcClientes = new BroadcastChannel(CLIENTES_SYNC_CHANNEL);
                    bcClientes.onmessage = function(ev) {
                        const msg = ev && ev.data ? ev.data : null;
                        if (!msg || msg.type !== 'clientes_updated') return;
                        sincronizarClientesDoCache();
                    };
                }
            } catch (e) {
                bcClientes = null;
            }

            // Storage (sempre)
            window.addEventListener('storage', function(e) {
                if (!e) return;
                if (e.key === CLIENTES_CACHE_KEY || e.key === CLIENTES_SYNC_KEY) {
                    sincronizarClientesDoCache();
                }
            });
        }

        function upsertClienteNaSelecaoRapida(cliente) {
            const c = sanitizarClienteParaLista(cliente);
            if (!c || !c.id) return;

            const idStr = String(c.id);

            // Atualiza/inclui
            const idx = (listaClientesCache || []).findIndex(function(x) {
                return String((x && x.id) || '') === idStr;
            });

            if (idx >= 0) listaClientesCache[idx] = c;
            else listaClientesCache.unshift(c);

            // Recria índice e atualiza UI
            rebuildClientesIndex();
            popularDatalistClientes();
            renderSugestoesClientes();

            // Salva cache e avisa outras abas
            salvarClientesNoCache();
            broadcastClientesUpdated();
        }


        function normalizarCPFFrontend(valor) {
            const digitos = String(valor || '').replace(/\D/g, '');
            if (!digitos) return '';
            return digitos.padStart(11, '0').slice(-11);
        }

        function formatarCPFParaExibicao(cpf) {
            const bruto = String(cpf || '').trim();
            const digitos = bruto.replace(/\D/g, '');
            if (digitos.length === 11) {
                return digitos.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
            }
            // Quando vier mascarado da API (***.***.***-**) preserva visual
            return bruto || '-';
        }

        // =====================================================================
        // INICIALIZAÇÃO
        // =====================================================================

        document.addEventListener('DOMContentLoaded', function() {
            // 1. Proteção de Rota
            if (!Auth.protectRoute()) return;

            // 2. UI do Usuário
            Auth.updateUserInfoUI();
            const user = Auth.getUser();
            if (user && user.nome) {
                const initialsEl = document.getElementById('user-initials');
                if (initialsEl) initialsEl.textContent = user.nome.substring(0, 1).toUpperCase();
            }

            // 3. Logout Desktop
            const btnLogout = document.getElementById('desktop-logout-btn');
            if (btnLogout) {
                btnLogout.addEventListener('click', () => { if (confirm('Sair?')) Auth.logout(); });
            }

            // 4. Inicializa datepicker
            flatpickr("#data_entrada", {
                locale: "pt",
                dateFormat: "d/m/Y",
                defaultDate: new Date()
            });

            // 5. Máscaras
            aplicarMascaras();

            // 6. Lógica do campo "Outros"
            const tipoSelect = document.getElementById('tipo');
            const divOutros = document.getElementById('div-tipo-outro');
            const inputOutros = document.getElementById('tipo_outro');

            if (tipoSelect && divOutros && inputOutros) {
                tipoSelect.addEventListener('change', function() {
                    if (this.value === 'OUTROS') {
                        divOutros.classList.remove('hidden');
                        inputOutros.setAttribute('required', 'true');
                        inputOutros.focus();
                    } else {
                        divOutros.classList.add('hidden');
                        inputOutros.removeAttribute('required');
                        inputOutros.value = '';
                    }
                });
            }

            // 7. Eventos
            document.getElementById('btn-buscar-cpf').addEventListener('click', buscarCliente);
            document.getElementById('btn-usar-cliente-rapido').addEventListener('click', confirmarClienteRapido);
            document.getElementById('form-processo').addEventListener('submit', salvarProcesso);
            initClientesSync();
            carregarClientesRapido();

            // Enter no campo CPF
            document.getElementById('cpf-busca').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    buscarCliente();
                }
            });

            const inputRapido = document.getElementById('cliente-busca-rapida');
            inputRapido.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    selecionarClienteRapido();
                }
            });
            inputRapido.addEventListener('input', renderSugestoesClientes);
            inputRapido.addEventListener('focus', renderSugestoesClientes);
            document.addEventListener('click', function(e) {
                const box = document.getElementById('clientes-sugestoes');
                const wrap = document.getElementById('cliente-busca-rapida').parentElement;
                if (box && wrap && !wrap.contains(e.target)) box.classList.add('hidden');
            });
        });

        // =====================================================================
        // SELEÇÃO RÁPIDA DE CLIENTES CADASTRADOS
        // =====================================================================
        async function carregarClientesRapido() {
            try {
                // 0) Cache imediato (deixa a tela rápida)
                const cached = Utils.Cache.get(CLIENTES_CACHE_KEY);
                if (Array.isArray(cached) && cached.length) {
                    listaClientesCache = cached;
                    rebuildClientesIndex();
                    popularDatalistClientes();
                    renderSugestoesClientes();
                }

                // 1) Rede em background (atualiza sem travar)
                const rede = await API.call('listarClientes', {}, 'POST', true);
                if (Array.isArray(rede)) {
                    listaClientesCache = rede;
                    rebuildClientesIndex();
                    popularDatalistClientes();
                    renderSugestoesClientes();
                    salvarClientesNoCache();
                    broadcastClientesUpdated();
                }
            } catch (e) {
                console.warn('Não foi possível carregar clientes para seleção rápida:', e.message || e);
            }
        }
        function popularDatalistClientes() {
            const datalist = document.getElementById('clientes-lista');
            if (!datalist) return;

            datalist.innerHTML = '';

            // Limite para evitar “lag” quando existir MUITOS clientes
            const max = 500;
            const lista = (listaClientesCache || []).slice(0, max);

            lista.forEach(function(c) {
                const opt = document.createElement('option');
                const nome = c.nome_completo || '';
                const cpf = c.cpf || '';
                const email = c.email || '';
                opt.value = nome + ' | ' + cpf + ' | ' + email;
                datalist.appendChild(opt);
            });
        }

        
        function escapeHtml(text) {
            return String(text || '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

function filtrarClientesRapido(termo) {
            const t = String(termo || '').toLowerCase().trim();
            const tCpf = t.replace(/\D/g, '');
            if (!t) return listaClientesCache.slice(0, 8);
            return listaClientesCache.filter(function(c) {
                const nome = String(c.nome_completo || '').toLowerCase();
                const email = String(c.email || '').toLowerCase();
                const cpfMask = String(c.cpf || '').toLowerCase();
                const cpfDigits = cpfMask.replace(/\D/g, '');
                return nome.includes(t) || email.includes(t) || cpfMask.includes(t) || (tCpf && cpfDigits.includes(tCpf));
            }).slice(0, 8);
        }

        function renderSugestoesClientes() {
            const box = document.getElementById('clientes-sugestoes');
            const input = document.getElementById('cliente-busca-rapida');
            if (!box || !input) return;

            const termo = input.value || '';
            const itens = filtrarClientesRapido(termo);

            if (!itens.length) {
                box.innerHTML = '<div class="px-3 py-2 text-sm text-slate-400">Nenhum cliente encontrado.</div>';
                box.classList.remove('hidden');
                return;
            }

            box.innerHTML = itens.map(function(c) {
                const nome = escapeHtml(c.nome_completo || '-');
                const cpf = escapeHtml(c.cpf || '-');
                const email = escapeHtml(c.email || '-');
                const valor = escapeHtml((c.nome_completo || '') + ' | ' + (c.cpf || '') + ' | ' + (c.email || ''));
                const id = escapeHtml(String(c.id || ''));
                return '<button type="button" class="w-full text-left px-3 py-2 hover:bg-slate-50 border-b border-slate-100 last:border-b-0" data-cliente="' + valor + '" data-id="' + id + '">' +
                       '<div class="text-sm font-medium text-slate-700">' + nome + '</div>' +
                       '<div class="text-xs text-slate-500">' + cpf + ' · ' + email + '</div>' +
                       '</button>';
            }).join('');

            box.classList.remove('hidden');
            box.querySelectorAll('[data-cliente]').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    // Seleciona o candidato (sem confirmar duas vezes)
                    const id = this.getAttribute('data-id');
                    const texto = this.getAttribute('data-cliente');
                    input.value = texto;
                    box.classList.add('hidden');
                    clienteCandidatoRapido = clientesById[String(id)] || null;
                });
            });
        }
        
        async function confirmarClienteRapido() {
            // Se o usuário clicou em uma sugestão, usamos o candidato diretamente (mais rápido e sem duplicar toast)
            if (clienteCandidatoRapido && clienteCandidatoRapido.id) {
                mostrarClienteEncontrado(clienteCandidatoRapido, { silentToast: false });
                avancarParaProcesso();
                return;
            }
            // Caso contrário, executa a busca inteligente pelo texto digitado
            return selecionarClienteRapido(null);
        }

async function selecionarClienteRapido(clienteIdForcado) {
            const input = document.getElementById('cliente-busca-rapida');
            const termoBruto = String(input.value || '').trim();
            const termo = termoBruto.toLowerCase();

            const btnUsar = document.getElementById('btn-usar-cliente-rapido');
            if (btnUsar) {
                btnUsar.classList.add('btn-loading');
                btnUsar.disabled = true;
            }

            try {
                if (!termoBruto && !clienteIdForcado) {
                    Utils.showToast('Digite um cliente para selecionar.', 'warning');
                    input.focus();
                    return;
                }

                let cliente = null;

                // 1) Clique direto na sugestão
                if (clienteIdForcado) {
                    cliente = clientesById[String(clienteIdForcado)] || null;
                }

                // 2) Tentativas: ID, CPF, Email, Nome
                if (!cliente && termoBruto) {

                    // ID direto
                    if (/^\d+$/.test(termoBruto)) {
                        cliente = clientesById[String(termoBruto)] || null;
                    }

                    // CPF (digits)
                    if (!cliente) {
                        const digits = termoBruto.replace(/\D/g, '');
                        if (digits.length >= 6) {
                            const candidatosCpf = (listaClientesCache || []).filter(function(c) {
                                const cCpf = String(c.cpf || '').replace(/\D/g, '');
                                return cCpf && cCpf.includes(digits);
                            });

                            if (candidatosCpf.length === 1) cliente = candidatosCpf[0];
                            else if (candidatosCpf.length > 1) {
                                Utils.showToast('Encontrei mais de 1 cliente com esse CPF. Refine a busca.', 'warning');
                                renderSugestoesClientes();
                                return;
                            }
                        }
                    }

                    // Email exato
                    if (!cliente && termo.includes('@')) {
                        const byEmail = (listaClientesCache || []).filter(function(c) {
                            return String(c.email || '').toLowerCase() === termo;
                        });

                        if (byEmail.length === 1) cliente = byEmail[0];
                        else if (byEmail.length > 1) {
                            Utils.showToast('Encontrei mais de 1 cliente com esse email. Refine a busca.', 'warning');
                            renderSugestoesClientes();
                            return;
                        }
                    }

                    // Nome contém
                    if (!cliente && termo.length >= 3) {
                        const byNome = (listaClientesCache || []).filter(function(c) {
                            return String(c.nome_completo || '').toLowerCase().includes(termo);
                        });

                        if (byNome.length === 1) cliente = byNome[0];
                        else if (byNome.length > 1) {
                            Utils.showToast('Encontrei mais de 1 cliente com esse nome. Clique na sugestão desejada.', 'warning');
                            renderSugestoesClientes();
                            return;
                        }
                    }
                }

                if (!cliente) {
                    Utils.showToast('Cliente não encontrado na lista. Use a busca por CPF abaixo.', 'warning');
                    return;
                }

                // Esconde sugestões ao selecionar
                const sug = document.getElementById('clientes-sugestoes');
                if (sug) sug.classList.add('hidden');

                // ✅ Mostra IMEDIATO (sem aguardar planilha)
                clienteCandidatoRapido = cliente;
                mostrarClienteEncontrado(cliente);
                avancarParaProcesso();

                const cpfInput = document.getElementById('cpf-busca');
                if (cpfInput) cpfInput.value = formatarCPFParaExibicao(cliente.cpf);

                // ✅ Busca dados completos em BACKGROUND (não trava)
                if (cliente.id) {
                    API.clientes.buscarPorId(cliente.id)
                        .then(function(completo) {
                            if (completo && completo.id) {
                                upsertClienteNaSelecaoRapida(completo);

                                // Se ainda for o mesmo selecionado, atualiza “por cima”
                                if (clienteSelecionado && String(clienteSelecionado.id) === String(completo.id)) {
                                    mostrarClienteEncontrado(completo, { silentToast: true });
                                    if (cpfInput) cpfInput.value = formatarCPFParaExibicao(completo.cpf);
                                }
                            }
                        })
                        .catch(function(err) {
                            console.warn('Falha ao buscar cliente completo (background):', err);
                        });
                }

            } finally {
                if (btnUsar) {
                    btnUsar.classList.remove('btn-loading');
                    btnUsar.disabled = false;
                }
            }
        }

        // =====================================================================
        // MÁSCARAS
        // =====================================================================

        function aplicarMascaras() {
            // CPF
            document.getElementById('cpf-busca').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 11) value = value.substring(0, 11);
                if (value.length > 9) {
                    value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{1,2})/, '$1.$2.$3-$4');
                } else if (value.length > 6) {
                    value = value.replace(/(\d{3})(\d{3})(\d{1,3})/, '$1.$2.$3');
                } else if (value.length > 3) {
                    value = value.replace(/(\d{3})(\d{1,3})/, '$1.$2');
                }
                e.target.value = value;
            });

            // Telefone
            document.getElementById('novo-cliente-telefone').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 11) value = value.substring(0, 11);
                if (value.length > 6) {
                    value = value.replace(/(\d{2})(\d{5})(\d{0,4})/, '($1) $2-$3');
                } else if (value.length > 2) {
                    value = value.replace(/(\d{2})(\d{0,5})/, '($1) $2');
                }
                e.target.value = value;
            });
        }

        // =====================================================================
        // BUSCA DE CLIENTE
        // =====================================================================

        async function buscarCliente() {
            const cpfInput = document.getElementById('cpf-busca');
            const cpf = normalizarCPFFrontend(cpfInput.value);

            if (cpf.length !== 11) {
                Utils.showToast('Digite um CPF válido com 11 dígitos.', 'warning');
                cpfInput.focus();
                return;
            }

            const btn = document.getElementById('btn-buscar-cpf');
            btn.classList.add('btn-loading');
            btn.disabled = true;

            try {
                // Chama a API usando o padrão do sistema
                const resultado = await API.call('buscarClientePorCPF', { cpf: cpf }, 'POST', true);

                // Esconde os dois estados
                document.getElementById('cliente-encontrado').classList.add('hidden');
                document.getElementById('cliente-nao-encontrado').classList.add('hidden');

                if (resultado) {
                    // Cliente encontrado!
                    mostrarClienteEncontrado(resultado);
                } else {
                    // Cliente não encontrado
                    mostrarFormNovoCliente(cpf);
                }

            } catch (error) {
                console.error('Erro ao buscar cliente:', error);
                // Se erro for "não encontrado", mostra formulário
                if (error.message && error.message.toLowerCase().includes('não encontrado')) {
                    mostrarFormNovoCliente(cpf);
                } else {
                    Utils.showToast(error.message || 'Erro ao buscar cliente.', 'error');
                }
            } finally {
                btn.classList.remove('btn-loading');
                btn.disabled = false;
            }
        }

        // =====================================================================
        // EXIBIÇÃO DE RESULTADOS
        // =====================================================================

        function mostrarClienteEncontrado(cliente, opts) {
            opts = opts || {};
            clienteSelecionado = cliente;

            // Formata CPF para exibição (respeita CPF mascarado e evita zeros indevidos)
            const cpfDisplay = formatarCPFParaExibicao(cliente.cpf);

            document.getElementById('cliente-iniciais').textContent = cliente.nome_completo ? cliente.nome_completo.charAt(0).toUpperCase() : 'C';
            document.getElementById('cliente-nome').textContent = cliente.nome_completo;
            document.getElementById('cliente-email').textContent = cliente.email || '-';
            document.getElementById('cliente-cpf-display').textContent = 'CPF: ' + cpfDisplay;
            document.getElementById('cliente-id-selecionado').value = cliente.id;

            // Auto-preenche campos do processo para evitar erro de obrigatoriedade
            try {
                const inpParte = document.getElementById('parte_nome');
                if (inpParte && !String(inpParte.value || '').trim()) {
                    inpParte.value = (cliente.nome_completo || cliente.nome || '').trim();
                }
                const inpEmail = document.getElementById('email_interessado');
                if (inpEmail && !String(inpEmail.value || '').trim()) {
                    inpEmail.value = String(cliente.email || '').trim().toLowerCase();
                }
            } catch (e) {
                // silêncio
            }

            document.getElementById('cliente-encontrado').classList.remove('hidden');
            document.getElementById('cliente-nao-encontrado').classList.add('hidden');
            document.getElementById('opcao-pular').classList.add('hidden');

                        // Evita toast duplicado (ex.: atualização em background)
            if (!opts.silentToast) {
                const idAtual = cliente && cliente.id ? String(cliente.id) : '';
                const agora = Date.now();
                if (idAtual && (_ultimoToastClienteId !== idAtual || (agora - _ultimoToastAt) > 2500)) {
                    _ultimoToastClienteId = idAtual;
                    _ultimoToastAt = agora;
                    Utils.showToast('Cliente selecionado!', 'success');
                }
            }
        }

        function mostrarFormNovoCliente(cpf) {
            // Formata o CPF para exibição
            let cpfFormatado = cpf.padStart(11, '0');
            cpfFormatado = cpfFormatado.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');

            document.getElementById('novo-cliente-cpf').value = cpfFormatado;

            document.getElementById('cliente-nao-encontrado').classList.remove('hidden');
            document.getElementById('cliente-encontrado').classList.add('hidden');
            document.getElementById('opcao-pular').classList.add('hidden');

            // Foca no nome
            setTimeout(() => {
                document.getElementById('novo-cliente-nome').focus();
            }, 300);
        }

        function limparCliente() {
            clienteSelecionado = null;
            document.getElementById('cpf-busca').value = '';
            document.getElementById('cliente-encontrado').classList.add('hidden');
            document.getElementById('cliente-nao-encontrado').classList.add('hidden');
            document.getElementById('opcao-pular').classList.remove('hidden');
            document.getElementById('cpf-busca').focus();
        }

        // =====================================================================
        // CADASTRO DE NOVO CLIENTE
        // =====================================================================

        async function cadastrarEAvancar() {
            const nome = document.getElementById('novo-cliente-nome').value.trim();
            const cpf = normalizarCPFFrontend(document.getElementById('novo-cliente-cpf').value);
            const email = document.getElementById('novo-cliente-email').value.trim().toLowerCase();
            const telefone = document.getElementById('novo-cliente-telefone').value.replace(/\D/g, '');

            // Validações
            if (!nome) {
                Utils.showToast('Digite o nome do cliente.', 'warning');
                document.getElementById('novo-cliente-nome').focus();
                return;
            }

            if (!email) {
                Utils.showToast('Digite o email do cliente.', 'warning');
                document.getElementById('novo-cliente-email').focus();
                return;
            }

            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                Utils.showToast('Digite um email válido.', 'warning');
                document.getElementById('novo-cliente-email').focus();
                return;
            }

            const btn = document.getElementById('btn-cadastrar-cliente');
            btn.classList.add('btn-loading');
            btn.disabled = true;

            try {
                const resultado = await API.call('cadastrarCliente', {
                    nome_completo: nome,
                    cpf: cpf,
                    email: email,
                    telefone: telefone
                });

                clienteSelecionado = resultado;
                upsertClienteNaSelecaoRapida(resultado);
                Utils.showToast('Cliente cadastrado com sucesso!', 'success');

                // Avança para o passo 2
                setTimeout(() => {
                    avancarParaProcesso();
                }, 500);

            } catch (error) {
                console.error('Erro ao cadastrar cliente:', error);
                Utils.showToast(error.message || 'Erro ao cadastrar cliente.', 'error');
            } finally {
                btn.classList.remove('btn-loading');
                btn.disabled = false;
            }
        }

        // =====================================================================
        // NAVEGAÇÃO ENTRE PASSOS
        // =====================================================================

        function avancarParaProcesso() {
            clienteVinculado = true;

            // Atualiza stepper
            document.getElementById('step1-indicator').classList.remove('step-active');
            document.getElementById('step1-indicator').classList.add('step-complete');
            document.getElementById('step1-indicator').innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';

            document.getElementById('step2-indicator').classList.remove('step-pending');
            document.getElementById('step2-indicator').classList.add('step-active');

            document.getElementById('progress-bar').style.width = '100%';

            // Mostra resumo do cliente
            if (clienteSelecionado) {
                document.getElementById('resumo-cliente').classList.remove('hidden');
                document.getElementById('resumo-cliente-nome').textContent = clienteSelecionado.nome_completo || clienteSelecionado.nome;

                // Preenche campos automaticamente
                document.getElementById('parte_nome').value = clienteSelecionado.nome_completo || clienteSelecionado.nome || '';
                document.getElementById('email_interessado').value = clienteSelecionado.email || '';
            }

            // Troca de tela
            document.getElementById('step1-content').classList.add('hidden');
            document.getElementById('step2-content').classList.remove('hidden');

            // Scroll para o topo
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function pularCadastroCliente() {
            clienteSelecionado = null;
            clienteVinculado = false;

            // Atualiza stepper
            document.getElementById('step1-indicator').classList.remove('step-active');
            document.getElementById('step1-indicator').classList.add('step-complete');
            document.getElementById('step1-indicator').innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';

            document.getElementById('step2-indicator').classList.remove('step-pending');
            document.getElementById('step2-indicator').classList.add('step-active');

            document.getElementById('progress-bar').style.width = '100%';

            // Esconde resumo do cliente
            document.getElementById('resumo-cliente').classList.add('hidden');

            // Troca de tela
            document.getElementById('step1-content').classList.add('hidden');
            document.getElementById('step2-content').classList.remove('hidden');

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function voltarParaCliente() {
            // Atualiza stepper
            document.getElementById('step1-indicator').classList.remove('step-complete');
            document.getElementById('step1-indicator').classList.add('step-active');
            document.getElementById('step1-indicator').textContent = '1';

            document.getElementById('step2-indicator').classList.remove('step-active');
            document.getElementById('step2-indicator').classList.add('step-pending');

            document.getElementById('progress-bar').style.width = '0%';

            // Troca de tela
            document.getElementById('step2-content').classList.add('hidden');
            document.getElementById('step1-content').classList.remove('hidden');

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // =====================================================================
        // SALVAR PROCESSO
        // =====================================================================

        async function salvarProcesso(e) {
            e.preventDefault();

            const numero = document.getElementById('numero_processo').value.trim();
            const tipoSelect = document.getElementById('tipo');
            const inputOutros = document.getElementById('tipo_outro');
            const parte = document.getElementById('parte_nome').value.trim();
            const dataEntrada = document.getElementById('data_entrada').value;
            const email = document.getElementById('email_interessado').value.trim();
            const descricao = document.getElementById('descricao').value.trim();

            // Lógica para definir o Tipo final
            let tipoFinal = tipoSelect.value;
            if (tipoFinal === 'OUTROS') {
                tipoFinal = inputOutros.value.trim().toUpperCase();
                if (!tipoFinal) {
                    Utils.showToast('Por favor, especifique o tipo do processo.', 'warning');
                    inputOutros.focus();
                    return;
                }
            }

            // Validações
            if (!numero) {
                Utils.showToast('Digite o número do processo.', 'warning');
                document.getElementById('numero_processo').focus();
                return;
            }
            if (!tipoFinal) {
                Utils.showToast('Selecione o tipo do processo.', 'warning');
                return;
            }
            if (!parte) {
                Utils.showToast('Digite o nome da parte interessada.', 'warning');
                document.getElementById('parte_nome').focus();
                return;
            }

            // Loader customizado
            Utils.showLoading("Criando pasta digital...", "database");

            try {
                // Monta payload
                const payload = {
                    numero_processo: numero,
                    tipo: tipoFinal,
                    parte_nome: parte,
                    data_entrada: dataEntrada,
                    email_interessado: email.toLowerCase(),
                    descricao: descricao
                };

                // Se tiver cliente selecionado, adiciona CPF ao payload
                if (clienteSelecionado) {
                    if (clienteSelecionado.id) {
                        payload.cliente_id = String(clienteSelecionado.id).trim();
                    }

                    const cpfNorm = normalizarCPFFrontend(clienteSelecionado.cpf);
                    if (cpfNorm.length === 11) {
                        payload.cpf_cliente = cpfNorm;
                    }

                    payload.nome_cliente = (clienteSelecionado.nome_completo || clienteSelecionado.nome || '').trim();
                    payload.email_cliente = (clienteSelecionado.email || '').trim().toLowerCase();
                    payload.telefone_cliente = String(clienteSelecionado.telefone || '').replace(/\D/g, '');
                }

                const resultado = await API.call('criarProcesso', payload, 'POST', true);

                // Limpa cache
                Utils.Cache.clear('listarProcessos');
                Utils.Cache.clear('getDashboard');

                Utils.showToast('Processo cadastrado com sucesso!', 'success');

                // Redireciona
                Utils.showLoading("Abrindo processo jurídico...", "database");

                setTimeout(() => {
                    if (resultado && resultado.id) {
                        Utils.navigateTo('detalhe-processo.html?id=' + resultado.id);
                    } else {
                        Utils.navigateTo('processos.html');
                    }
                }, 1500);

            } catch (error) {
                console.error('Erro ao salvar processo:', error);
                Utils.hideLoading();

                if (error.message && error.message.includes('Já existe')) {
                    Utils.showToast(error.message, 'error');
                    const campoNumero = document.getElementById('numero_processo');
                    campoNumero.focus();
                    campoNumero.classList.add('border-red-500');
                    setTimeout(() => campoNumero.classList.remove('border-red-500'), 3000);
                } else {
                    Utils.showToast(error.message || 'Erro ao cadastrar processo.', 'error');
                }
            }
        }
    </script>

</body>
</html>
